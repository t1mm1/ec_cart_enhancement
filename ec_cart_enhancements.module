<?php

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function ec_cart_enhancements_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.ec_cart_enhancements':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Enhances Drupal Commerce cart functionality with improved popup display showing full cart contents.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function ec_cart_enhancements_theme($existing, $type, $theme, $path): array {
  return [
    'dc_ajax_add_cart_popup' => [
      'template' => 'dc-ajax-add-cart-popup',
      'path' => $path . '/templates',
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK() for dc_ajax_add_cart_popup.
 */
function ec_cart_enhancements_preprocess_dc_ajax_add_cart_popup(&$variables): void {
  $variables['#attached']['library'][] = 'ec_cart_enhancements/styles';

  $cart_provider = \Drupal::service('commerce_cart.cart_provider');
  $current_store = \Drupal::service('commerce_store.current_store');

  $store = $current_store->getStore();
  if (!$store) {
    $variables['empty'] = TRUE;
    return;
  }

  $carts = $cart_provider->getCarts();
  if (empty($carts)) {
    $variables['empty'] = TRUE;
    return;
  }

  try {
    // Get all carts.
    $carts_data = [];
    foreach ($carts as $cid => $cart) {
      $cart_items = [];
      $cart_count = 0;
      foreach ($cart->getItems() as $order_item) {
        $cart_count += (int) $order_item->getQuantity();

        $purchased_entity = $order_item->getPurchasedEntity();
        if ($purchased_entity) {
          $cart_items[] = [
            'title' => $order_item->getTitle(),
            'quantity' => $order_item->getQuantity(),
            'unit_price' => $order_item->getUnitPrice(),
            'total_price' => $order_item->getTotalPrice(),
          ];
        }

        $carts_data[$cid] = [
          'items' => $cart_items,
          'count' => $cart_count,
          'total' => $cart->getTotalPrice(),
        ];
      }
    }

    $variables['carts'] = $carts_data;

    // Cache.
    $variables['#cache']['tags'] = ['commerce_order:' . $cart->id(), 'cart'];
    $variables['#cache']['contexts'] = ['user', 'session'];
  }
  catch (\Exception $e) {
    \Drupal::logger('ec_cart_enhancements')->error('Error: @message', ['@message' => $e->getMessage()]);
    $variables['cart_count'] = 0;
  }
}

/**
 * Implements hook_theme_suggestions_HOOK_alter().
 */
function ec_cart_enhancements_theme_suggestions_dc_ajax_add_cart_popup_alter(array &$suggestions, array $variables): void {
  if (isset($variables['product_variation_entity'])) {
    $product_variation = $variables['product_variation_entity'];
    $suggestions[] = 'dc_ajax_add_cart_popup__' . $product_variation->bundle();
  }
}
